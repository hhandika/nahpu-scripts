---
title: "NAHPU Export Data Cleaning"
author: "Heru Handika"
date: "2023-06-16"
output: html_document
---

```{r}
library(pacman)
pacman::p_load(readr)
pacman::p_load(dplyr)
pacman::p_load(here)
pacman::p_load(tidyr)

```


```{r}
path <- here::here("data", "hh_gede2023_specimenRecords.csv")

df <- readr::read_csv(path)
```

```{r}

main.lsumz_cols <- "Catalog Number	Alt Catalog Number	Genus	Species	Sex	Continent	Country	State	County	Locality Name	Elevation	Elevation Unit	CollectorLastName1	Field Number	Start Date"

prep_type.lsumz_cols <- "PrepType1	PreparedDate1	Count1	TissueType1	Preservation1	StorageLocation1	PrepType2	PreparedDate2	Count2	TissueType2	Preservation2	StorageLocation2	PrepType3	PreparedDate3	Count3	TissueType3	Preservation3	StorageLocation3	PrepType4	PreparedDate4	Count4	TissueType4	Preservation4	StorageLocation4	PrepType5	PreparedDate5	Count5	TissueType5	Preservation5	StorageLocation5	PrepType6	PreparedDate6	Count6	TissueType6	Preservation6	StorageLocation6	PrepType7	PreparedDate7	Count7	TissueType7	Preservation7	StorageLocation7	PrepType8	PreparedDate8	Count8	TissueType8	Preservation8	StorageLocation8	PrepType9	PreparedDate9	Count9	TissueType9	Preservation9	StorageLocation9	PrepType10	PreparedDate10	Count10	TissueType10	Preservation10	StorageLocation10"

prep_types.lsumz_cols <- "PrepType	PreparedDate	Count	TissueType	Preservation	StorageLocation"

coordinate.lsumz_cols <- "Latitude Longitude	MaxErrorDistance"

measurements.lsumz_cols <- "Total Length Tail Length	Hind Foot Length	Ear Length	Weight	Remarks"

prepType.size <- df$preparation |>
  # Escape pipe so stringr does not confuse it with OR operator
  stringr::str_count(pattern = "\\|") |> 
  # One extra to accommodate the split
  max() + 1 

prepType.colnames <- paste0("PrepType", 1:prepType.size)

prepType.allCols <- stringr::str_split(prep_types.lsumz_cols, pattern = "\t")
prepType.allCols


clean_collname <- function(df) {
  df |> 
    dplyr::rename(collectorLastName = cataloger) |>
    dplyr::rename(species = specificEpithet) |>
    dplyr::rename(prepType = preparation) |>
    tidyr::unite("Locality", municipality:specificLocality, sep = ", ", remove = FALSE) |>
    tidyr::separate_wider_delim(prepType, delim = "|", names = prepType.colnames,  too_few = "align_start")
}

cleaned.df <- clean_collname(df) 
readr::write_csv(cleaned.df, here::here("results", "cleaned_lsumz_upload.csv"))
# 
# test <- names(df) %>% 
#   purrr::map_dfc(~ df %>% 
#              select(.x) %>% 
#              separate(.x, 
#                       into = paste0(.x, c("_attempted", "_landed")), 
#                       sep = ";")
#            )

```

